# Following the advice given in https://pve.proxmox.com/wiki/Pci_passthrough
# Adapted from https://github.com/Maghin/ansible-pve-pcipassthrough

# Enable the IOMMU
- name: Ensure iommu is enabled in default grub command line
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    backrefs: true
    regexp: '^#?(GRUB_CMDLINE_LINUX_DEFAULT=.*)quiet"$'
    # TODO: find CPU vendor automatically
    line: '\1quiet {{ pci_cpu_vendor }}_iommu=on"'
  register: pci_grubfile_result
  notify: Update grub configuration
# Required Modules
- name: Ensure vfio modules are loaded at boot
  ansible.builtin.lineinfile:
    path: "/etc/modules"
    line: "{{ item }}"
  register: pci_vfio_result
  with_items: "{{ pci_modules }}"
# IOMMU Interrupt Remapping (unsafe interrupts)
- name: Ensure unsafe interrupts are allowed
  ansible.builtin.lineinfile:
    path: /etc/modprobe.d/iommu_unsafe_interrupts.conf
    create: true
    mode: 0655
    line: "options vfio_iommu_type1 allow_unsafe_interrupts=1"
  when: pci_unsafe_remapping
  register: pci_unsafe_interrupts_result
# Driver Blacklisting (for GPU passthrough)
- name: Ensure selected modules are blacklisted
  ansible.builtin.lineinfile:
    path: "/etc/modprobe.d/blacklist.conf"
    create: true
    mode: 0655
    line: "blacklist {{ item }}"
  register: pci_blacklist_result
  with_items: "{{ pci_blacklist }}"
